# MIT License
# Copyright (c) 2024 Lecrapouille <lecrapouille@gmail.com>
#
# Prologot - SWI-Prolog integration for Godot 4
# GitHub Actions CI workflow for multi-platform builds
#
# This CI pipeline:
# 1. Builds and tests the Prologot extension for Linux, Windows, and macOS
# 2. Packages releases when a version tag is pushed (e.g., v1.0.0)
# 3. Lints GDScript files for code quality
#
# Workflow triggers:
# - Push to master branch: builds and tests all platforms
# - Pull requests to master: builds and tests all platforms
# - Version tags (v*): builds, tests, packages, and creates GitHub Release
# - Manual trigger: allows running the workflow from GitHub UI

name: Build and Test Prologot

on:
  push:
    branches: [master]
    tags:
      - "v*" # Trigger on version tags like v1.0.0, v0.1.0-beta, etc.
  pull_request:
    branches: [master]
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  # ============================================================================
  # Linux Build and Test Job
  # ============================================================================
  build-linux:
    name: Build & Test (Linux, Godot ${{ matrix.godot-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        godot-version: ["4.5"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache pip/scons
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-scons-${{ runner.os }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y swi-prolog swi-prolog-nox build-essential scons

      - name: Build extension
        run: make GODOT_CPP=${{ matrix.godot-version }} all

      - name: Download Godot Engine
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ matrix.godot-version }}-stable/Godot_v${{ matrix.godot-version }}-stable_linux.x86_64.zip
          unzip -q Godot_v${{ matrix.godot-version }}-stable_linux.x86_64.zip
          chmod +x Godot_v${{ matrix.godot-version }}-stable_linux.x86_64
          sudo mv Godot_v${{ matrix.godot-version }}-stable_linux.x86_64 /usr/local/bin/godot

      - name: Run unit tests
        run: make tests
        timeout-minutes: 2

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-linux-x86_64-godot${{ matrix.godot-version }}
          path: bin/linux
          retention-days: 1

  # ============================================================================
  # Windows Build Job
  # ============================================================================
  build-windows:
    name: Build & Test (Windows, Godot ${{ matrix.godot-version }})
    runs-on: windows-latest
    continue-on-error: true

    strategy:
      matrix:
        godot-version: ["4.5"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip/scons
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-scons-${{ runner.os }}

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install scons
          choco install swi-prolog --yes --no-progress
          Add-Content $env:GITHUB_PATH "C:\Program Files\swipl\bin"

      - name: Build extension
        run: |
          scons --godot-cpp=${{ matrix.godot-version }} target=template_debug arch=x86_64
          scons --godot-cpp=${{ matrix.godot-version }} target=template_release arch=x86_64

      - name: Download Godot Engine
        shell: pwsh
        run: |
          $v = "${{ matrix.godot-version }}"
          Invoke-WebRequest "https://github.com/godotengine/godot/releases/download/$v-stable/Godot_v$v-stable_win64.exe.zip" -OutFile godot.zip
          Expand-Archive godot.zip -DestinationPath .
          Rename-Item "Godot_v$v-stable_win64.exe" godot.exe
          Add-Content $env:GITHUB_PATH (Get-Location).Path

      - name: Run unit tests
        shell: pwsh
        timeout-minutes: 2
        run: |
          Copy-Item -Recurse bin tests\bin
          $env:PATH = "$(Resolve-Path tests\bin\windows);C:\Program Files\swipl\bin;$env:PATH"
          godot --headless --path tests -s run_tests.gd

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-windows-x86_64-godot${{ matrix.godot-version }}
          path: bin/windows
          retention-days: 1

  # ============================================================================
  # macOS Build Job
  # ============================================================================
  build-macos:
    name: Build & Test (macOS, Godot ${{ matrix.godot-version }})
    runs-on: macos-latest
    continue-on-error: true

    strategy:
      matrix:
        godot-version: ["4.5"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: brew install scons swi-prolog pkg-config

      - name: Build extension
        run: make GODOT_CPP=${{ matrix.godot-version }} all

      - name: Download Godot Engine
        run: |
          wget -q https://github.com/godotengine/godot/releases/download/${{ matrix.godot-version }}-stable/Godot_v${{ matrix.godot-version }}-stable_macos.universal.zip
          unzip -q Godot_v${{ matrix.godot-version }}-stable_macos.universal.zip
          chmod +x Godot.app/Contents/MacOS/Godot
          sudo mv Godot.app/Contents/MacOS/Godot /usr/local/bin/godot

      - name: Run unit tests
        run: godot --headless --path tests -s run_tests.gd
        timeout-minutes: 2

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-macos-arm64-godot${{ matrix.godot-version }}
          path: bin/macos
          retention-days: 1

  # ============================================================================
  # GDScript Linting Job
  # ============================================================================
  lint-gdscript:
    name: Lint GDScript
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-gdtoolkit-${{ runner.os }}

      - name: Install gdtoolkit
        run: pip install gdtoolkit

      - name: Lint GDScript files
        run: gdlint addons/ tests/

  # ============================================================================
  # Release Packaging Job
  # ============================================================================
  # Combines all platform builds into a single release package.
  #
  # For every CI run:
  #   - Creates prologot-<version>-godot<ver>.zip as a GitHub artifact (30 days)
  #
  # For version tags (v*):
  #   - Attaches prologot-<TAG>.zip to a GitHub Release (kept forever)
  #
  # Package structure:
  #   addons/prologot/
  #     bin/
  #       linux/    - Linux libs + swipl/
  #       windows/  - Windows libs + swipl/
  #       macos/    - macOS libs + swipl/
  #       prologot.gdextension
  #       VERSION
  #       LICENSE
  #     doc/        - Documentation (markdown + example script)
  #     plugin.cfg  - Godot plugin configuration
  #     plugin.gd   - Plugin entry point
  #     *.gd        - Other GDScript files
  # ============================================================================
  package:
    name: Package Release
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    if: always() # Run even if Windows/macOS builds fail — package what's available
    permissions:
      contents: write # Required to create GitHub Releases and upload assets

    strategy:
      matrix:
        godot-version: ["4.5"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip/scons
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-scons-${{ runner.os }}

      - name: Install SCons
        run: pip install scons

      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Prologot version: $VERSION"

      # Download all platform artifacts. Each artifact contains the contents
      # of bin/<platform>/ (libs + swipl/). Layout after download:
      #   artifacts/prologot-linux-x86_64-godot4.5/<files>
      #   artifacts/prologot-windows-x86_64-godot4.5/<files>
      #   artifacts/prologot-macos-arm64-godot4.5/<files>
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release folder
        run: |
          RELEASE_DIR="addons/prologot"
          mkdir -p "$RELEASE_DIR/doc"

          # Map artifact names to platform subdirectories
          declare -A PLATFORM_MAP=(
            [linux]="prologot-linux-x86_64-godot${{ matrix.godot-version }}"
            [windows]="prologot-windows-x86_64-godot${{ matrix.godot-version }}"
            [macos]="prologot-macos-arm64-godot${{ matrix.godot-version }}"
          )

          for platform in linux windows macos; do
            artifact_dir="artifacts/${PLATFORM_MAP[$platform]}"
            if [ -d "$artifact_dir" ]; then
              mkdir -p "$RELEASE_DIR/bin/$platform"
              cp -r "$artifact_dir"/. "$RELEASE_DIR/bin/$platform/"
              echo "✓ Copied $platform from: $artifact_dir"
            else
              echo "⚠ Artifact not found for $platform: $artifact_dir"
            fi
          done

          # Add VERSION and LICENSE at bin/ root
          cp VERSION LICENSE "$RELEASE_DIR/bin/"

          echo ""
          echo "=== Release bin/ structure ==="
          find "$RELEASE_DIR/bin" -type f | head -40 || echo "(none)"

          # Copy documentation
          cp doc/*.md doc/hello_world_prologot.gd "$RELEASE_DIR/doc/"

      # Use SConstruct to generate .gdextension based on available binaries
      - name: Generate prologot.gdextension
        run: |
          scons --gdextension=addons/prologot
          echo ""
          echo "=== Final package contents ==="
          find addons/prologot -type f | sort

      # Determine zip name: tagged releases get the tag name, CI runs get the version
      - name: Create release archive
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ZIP_NAME="prologot-${{ github.ref_name }}.zip"
          else
            ZIP_NAME="prologot-${{ steps.version.outputs.version }}-godot${{ matrix.godot-version }}.zip"
          fi
          mkdir -p prologot
          cp -r addons prologot/
          zip -r "$ZIP_NAME" prologot/
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV
          echo "Created archive: $ZIP_NAME"

      # Upload zip as GitHub artifact for non-tag CI runs (30-day retention)
      - name: Upload release zip artifact
        if: "!startsWith(github.ref, 'refs/tags/v')"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          retention-days: 30

      # Create GitHub Release and attach zip — only for version tags
      # Pre-release detection: alpha / beta / rc tags are marked accordingly
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
