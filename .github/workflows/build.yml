# MIT License
# Copyright (c) 2024 Lecrapouille <lecrapouille@gmail.com>
#
# Prologot - SWI-Prolog integration for Godot 4
# GitHub Actions CI workflow for multi-platform builds
#
# This CI pipeline:
# 1. Builds and tests the Prologot extension for Linux, Windows, and macOS
# 2. Packages releases when a version tag is pushed (e.g., v1.0.0)
# 3. Lints GDScript files for code quality
#
# Workflow triggers:
# - Push to master branch: builds and tests all platforms
# - Pull requests to master: builds and tests all platforms
# - Version tags (v*): builds, tests, packages, and creates GitHub Release
# - Manual trigger: allows running the workflow from GitHub UI

name: Build and Test Prologot

on:
  push:
    branches: [master]
    tags:
      - "v*" # Trigger on version tags like v1.0.0, v0.1.0-beta, etc.
  pull_request:
    branches: [master]
  workflow_dispatch: # Allow manual triggering from GitHub UI

jobs:
  # ============================================================================
  # Linux Build and Test Job
  # ============================================================================
  # Primary build target. Linux build is required for the release package.
  # Uses Ubuntu with system-installed SWI-Prolog and builds both debug/release.
  # ============================================================================
  build-linux:
    name: Build & Test (Linux, Godot ${{ matrix.godot-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        godot-version: ["4.5"] # List of Godot versions to build against
      fail-fast: false # Continue other matrix jobs if one fails

    steps:
      # Clone the repository and its submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install SWI-Prolog (runtime + development headers) and build tools
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y swi-prolog swi-prolog-nox build-essential scons

      # Build both debug and release variants using the Makefile
      - name: Build extension
        run: |
          make GODOT_CPP=${{ matrix.godot-version }} all

      # Download and install Godot headless binary for running tests
      - name: Download Godot Engine
        run: |
          wget https://github.com/godotengine/godot/releases/download/${{ matrix.godot-version }}-stable/Godot_v${{ matrix.godot-version }}-stable_linux.x86_64.zip
          unzip Godot_v${{ matrix.godot-version }}-stable_linux.x86_64.zip
          chmod +x Godot_v${{ matrix.godot-version }}-stable_linux.x86_64
          sudo mv Godot_v${{ matrix.godot-version }}-stable_linux.x86_64 /usr/local/bin/godot

      # Execute the GDScript test suite in headless mode
      - name: Run unit tests
        run: |
          make tests
        timeout-minutes: 2 # Prevent hanging tests from blocking CI

      # Upload compiled binaries for use by the packaging job
      # Short retention since these are intermediate artifacts
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-linux-x86_64-godot${{ matrix.godot-version }}
          path: |
            bin/
            prologot.gdextension
          retention-days: 1

  # ============================================================================
  # Windows Build Job
  # ============================================================================
  # Windows build using MSVC toolchain and Chocolatey for SWI-Prolog.
  # Marked as continue-on-error since Windows builds are less stable.
  # ============================================================================
  build-windows:
    name: Build (Windows, Godot ${{ matrix.godot-version }})
    runs-on: windows-latest
    continue-on-error: true # Allow Windows build to fail without blocking release

    strategy:
      matrix:
        godot-version: ["4.5"]
      fail-fast: false

    steps:
      # Clone the repository and its submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Set up Python. Python is required for SCons build system
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install SCons (build system used by Godot and therefore for this project)
      - name: Install SCons
        run: |
          python -m pip install scons

      # Install SWI-Prolog via Chocolatey (Windows package manager for CI)
      - name: Install SWI-Prolog via Chocolatey
        run: |
          choco install swi-prolog --yes --no-progress
        shell: pwsh

      # Configure SWI-Prolog environment. Set up environment variables needed by SCons to find SWI-Prolog
      - name: Configure SWI-Prolog environment
        run: |
          # Find the SWI-Prolog install directory
          $swiPath = "C:\Program Files\swipl"
          if (Test-Path $swiPath) {
            # Add to PATH for current process and GH Actions job steps
            $env:PATH = "$swiPath\bin;$env:PATH"
            echo "$swiPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

            # Set environment variables for SCons to locate SWI-Prolog
            echo "PLBASE=$swiPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            echo "PLLIBDIR=$swiPath\lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

            # Verify swipl is available
            Write-Host "SWI-Prolog installation verified:"
            swipl --version
            Write-Host "PLBASE: $swiPath"
            Write-Host "PLLIBDIR: $swiPath\lib"

            # Diagnostics: List important directories and files for debugging
            Write-Host "`n=== Diagnostic: Files in $swiPath\bin ==="
            Get-ChildItem "$swiPath\bin" -File | Select-Object Name, Length | Format-Table

            Write-Host "`n=== Diagnostic: Files in $swiPath\lib ==="
            if (Test-Path "$swiPath\lib") {
              Get-ChildItem "$swiPath\lib" -File -ErrorAction SilentlyContinue | Select-Object Name, Length | Format-Table
            } else {
              Write-Host "Directory $swiPath\lib does not exist"
            }

            Write-Host "`n=== Diagnostic: Search for *.lib, *.dll.a, and *.a files ==="
            Get-ChildItem "$swiPath" -Recurse -Include "*.lib","*.dll.a","*.a" -ErrorAction SilentlyContinue | Select-Object FullName, Length | Format-Table
          } else {
            Write-Error "SWI-Prolog not found at $swiPath"
          }
        shell: pwsh

      # Build extension (Debug)
      - name: Build extension (Debug)
        env:
          PYTHONIOENCODING: utf-8
          PLBASE: ${{ env.PLBASE }}
          PLLIBDIR: ${{ env.PLLIBDIR }}
        run: |
          echo "Building Debug version..."
          scons --godot-cpp=${{ matrix.godot-version }} target=template_debug arch=x86_64 verbose=1

      # Build extension (Release)
      - name: Build extension (Release)
        env:
          PYTHONIOENCODING: utf-8
          PLBASE: ${{ env.PLBASE }}
          PLLIBDIR: ${{ env.PLLIBDIR }}
        run: |
          echo "Building Release version..."
          scons --godot-cpp=${{ matrix.godot-version }} target=template_release arch=x86_64 verbose=1

      # Download Godot Engine for Windows for testing
      - name: Download Godot Engine
        run: |
          $godotVersion = "${{ matrix.godot-version }}"
          $url = "https://github.com/godotengine/godot/releases/download/$godotVersion-stable/Godot_v$godotVersion-stable_win64.exe.zip"
          $zipFile = "Godot_v$godotVersion-stable_win64.exe.zip"
          $exeFile = "Godot_v$godotVersion-stable_win64.exe"

          Write-Host "Downloading Godot $godotVersion for Windows..."
          Invoke-WebRequest -Uri $url -OutFile $zipFile

          Write-Host "Extracting Godot..."
          Expand-Archive -Path $zipFile -DestinationPath . -Force

          Write-Host "Moving Godot to PATH..."
          if (Test-Path $exeFile) {
            New-Item -ItemType Directory -Force -Path "$env:ProgramFiles\Godot" | Out-Null
            Move-Item -Path $exeFile -Destination "$env:ProgramFiles\Godot\godot.exe" -Force
            echo "$env:ProgramFiles\Godot" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Godot installed successfully"
            & "$env:ProgramFiles\Godot\godot.exe" --version
          } else {
            Write-Error "Godot executable not found after extraction"
          }
        shell: pwsh

      # Prepare test project. Copy built binaries to the test project directory
      - name: Prepare test project
        # Copy built binaries to the test project directory
        run: |
          Write-Host "Preparing test project..."
          if (Test-Path "tests\bin") { Remove-Item -Recurse -Force "tests\bin" }
          if (Test-Path "tests\prologot.gdextension") { Remove-Item -Force "tests\prologot.gdextension" }
          if (Test-Path "bin") { Copy-Item -Recurse "bin" "tests\bin" }
          if (Test-Path "prologot.gdextension") { Copy-Item "prologot.gdextension" "tests\prologot.gdextension" }
        shell: pwsh

      # Run tests with DLL paths configured for Windows. Add tests/bin and SWI-Prolog bin to PATH so Windows can find DLL dependencies
      - name: Run unit tests
        run: |
          # Add tests/bin and SWI-Prolog bin to PATH so Windows can find DLL dependencies
          $testsBinPath = (Resolve-Path "tests\bin").Path
          $swiBinPath = "C:\Program Files\swipl\bin"
          $env:PATH = "$testsBinPath;$swiBinPath;$env:PATH"
          Write-Host "Added to PATH:"
          Write-Host "  - $testsBinPath"
          Write-Host "  - $swiBinPath"
          Write-Host "DLLs in tests/bin:"
          Get-ChildItem "$testsBinPath\*.dll" | Select-Object Name
          godot --headless --path tests -s run_tests.gd
        timeout-minutes: 2
        shell: pwsh

      # Upload compiled binaries for use by the packaging job. Windows binaries (.dll files)
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-windows-x86_64-godot${{ matrix.godot-version }}
          path: |
            bin/
            prologot.gdextension
          retention-days: 1

  # ============================================================================
  # macOS Build Job
  # ============================================================================
  # macOS build using Homebrew for dependencies.
  # Marked as continue-on-error due to known segfault issues during tests.
  # ============================================================================
  build-macos:
    name: Build (macOS, Godot ${{ matrix.godot-version }})
    runs-on: macos-latest
    continue-on-error: true # Allow macOS build to fail without blocking release

    strategy:
      matrix:
        godot-version: ["4.5"]
      fail-fast: false

    steps:
      # Clone the repository and its submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Install build tools and SWI-Prolog via Homebrew
      - name: Install dependencies
        run: |
          brew install scons swi-prolog pkg-config

      # Build extension (Debug and Release)
      - name: Build extension
        run: |
          make GODOT_CPP=${{ matrix.godot-version }} all

      # Download Godot Engine for macOS for testing
      - name: Download Godot Engine
        run: |
          wget https://github.com/godotengine/godot/releases/download/${{ matrix.godot-version }}-stable/Godot_v${{ matrix.godot-version }}-stable_macos.universal.zip
          unzip Godot_v${{ matrix.godot-version }}-stable_macos.universal.zip
          chmod +x Godot.app/Contents/MacOS/Godot
          sudo mv Godot.app/Contents/MacOS/Godot /usr/local/bin/godot

      # Run unit tests.
      # FIXME: Tests are currently skipped due to segfault issues on macOS
      # This needs investigation - possibly related to SWI-Prolog initialization
      - name: Run unit tests
        run: |
          echo "⚠ Skipping tests on macOS due to segfault issues"
          # /usr/local/bin/godot --headless --quit --path tests -s run_tests.gd
        timeout-minutes: 2

      # Upload compiled binaries for use by the packaging job. macOS binaries (.dylib files)
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prologot-macos-arm64-godot${{ matrix.godot-version }}
          path: |
            bin/
            prologot.gdextension
          retention-days: 1

  # ============================================================================
  # GDScript Linting Job
  # ============================================================================
  # Static analysis of GDScript files to ensure code quality and consistency.
  # Uses gdtoolkit (gdlint) for linting.
  # ============================================================================
  lint-gdscript:
    name: Lint GDScript
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install gdtoolkit (gdlint for GDScript static analysis)
      - name: Install gdtoolkit
        run: |
          pip install gdtoolkit

      # Lint GDScript files. Check all GDScript files in addons/ and tests/ directories
      - name: Lint GDScript files
        run: |
          gdlint addons/ tests/

  # ============================================================================
  # Release Packaging Job
  # ============================================================================
  # This job combines all platform builds into a single release package.
  #
  # For every CI run:
  # - Creates prologot.zip artifact with all available platform binaries
  #
  # For version tags (v*):
  # - Creates prologot-<TAG>.zip and attaches it to GitHub Release
  # - GitHub Release files are kept indefinitely
  #
  # Package structure:
  #   addons/prologot/
  #     bin/                  - Compiled libraries (.so, .dll, .dylib)
  #     doc/                  - Documentation (markdown + example script)
  #     prologot.gdextension  - Godot extension configuration (all platforms)
  #     plugin.cfg            - Godot plugin configuration
  #     plugin.gd             - Plugin entry point
  #     *.gd                  - Other GDScript files
  # ============================================================================
  package:
    name: Package Release
    needs: [build-linux, build-windows, build-macos] # Wait for all builds
    runs-on: ubuntu-latest
    if: always() # Run even if Windows/macOS fail, package what's available
    permissions:
      contents: write # Required to create GitHub Releases and upload assets

    strategy:
      matrix:
        godot-version: ["4.5"]

    steps:
      # Clone the repository and its submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Set up Python. Python is required for SCons build system
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Install SCons (build system used by Godot and therefore for this project)
      - name: Install SCons
        run: pip install scons

      # Read version from VERSION file
      - name: Read version from VERSION file
        id: version
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Prologot version: $VERSION"

      # Download all artifacts from previous jobs
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      # Prepare release folder. Organize all files into the final release structure
      # Note: Godot plugin files (plugin.cfg, plugin.gd, etc.) are already
      # in addons/prologot/ from the checkout - no need to copy them.
      - name: Prepare release folder
        run: |
          RELEASE_DIR="addons/prologot"
          mkdir -p "$RELEASE_DIR/bin"
          mkdir -p "$RELEASE_DIR/doc"

          # Copy binaries from all platforms into bin/
          # Each platform's binaries are in separate artifact directories

          # Linux binaries (.so files)
          if ls artifacts/prologot-linux-*-godot${{ matrix.godot-version }}/bin/* 1>/dev/null 2>&1; then
            cp artifacts/prologot-linux-*-godot${{ matrix.godot-version }}/bin/* "$RELEASE_DIR/bin/"
            echo "✓ Linux binaries copied"
          else
            echo "⚠ Warning: Linux artifacts not available (build may have failed)"
          fi

          # Windows binaries (.dll files only, exclude .exp and .lib linker artifacts)
          if ls artifacts/prologot-windows-*-godot${{ matrix.godot-version }}/bin/*.dll 1>/dev/null 2>&1; then
            cp artifacts/prologot-windows-*-godot${{ matrix.godot-version }}/bin/*.dll "$RELEASE_DIR/bin/"
            echo "✓ Windows binaries copied (.dll only, excluded .exp/.lib)"
          else
            echo "⚠ Warning: Windows artifacts not available (build may have failed)"
          fi

          # macOS binaries (.dylib files)
          if ls artifacts/prologot-macos-*-godot${{ matrix.godot-version }}/bin/* 1>/dev/null 2>&1; then
            cp artifacts/prologot-macos-*-godot${{ matrix.godot-version }}/bin/* "$RELEASE_DIR/bin/"
            echo "✓ macOS binaries copied"
          else
            echo "⚠ Warning: macOS artifacts not available (build may have failed)"
          fi

          # Copy VERSION and LICENSE to doc/ for reference
          cp VERSION LICENSE "$RELEASE_DIR/doc"
          echo "✓ VERSION and LICENSE copied"

          # Copy documentation (markdown files only, exclude images/logos)
          cp doc/*.md "$RELEASE_DIR/doc/"
          cp doc/hello_world_prologot.gd "$RELEASE_DIR/doc/"
          echo "✓ Documentation copied"

      # Use SConstruct to generate .gdextension file based on available binaries
      # This ensures all platforms are listed correctly in a single file
      - name: Generate prologot.gdextension
        run: |
          scons --gdextension=addons/prologot
          echo ""
          echo "=== Final package contents ==="
          find addons/prologot -type f | sort

      # Upload the addons folder as a GitHub artifact
      # GitHub Actions automatically zips the folder when downloading
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: prologot-${{ steps.version.outputs.version }}-godot${{ matrix.godot-version }}
          path: addons/
          retention-days: 30

      # Create a zip file for distribution
      # Naming convention:
      #   - Tags: prologot-v1.0.0.zip (attached to GitHub Release, kept forever)
      #   - Other: prologot.zip (artifact only, kept 30 days)
      - name: Create release archive
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            ZIP_NAME="prologot-${{ github.ref_name }}.zip"
          else
            ZIP_NAME="prologot.zip"
          fi
          zip -r "$ZIP_NAME" addons/
          echo "Created: $ZIP_NAME"
          unzip -l "$ZIP_NAME" | head -50
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # Upload the zip file as a GitHub artifact (only for non-tag CI runs)
      # For tags, the zip is attached to GitHub Release instead (kept forever)
      - name: Upload release zip artifact
        if: "!startsWith(github.ref, 'refs/tags/v')"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          retention-days: 30

      # Create a GitHub Release with the zip file attached
      # Only runs for version tags (v1.0.0, v0.1.0-beta, etc.)
      # Pre-release detection: alpha/beta/rc tags are marked as pre-release
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          generate_release_notes: true # Auto-generate release notes from commits
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
